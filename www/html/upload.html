<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1">
    <title>SERVER_NAME/upload</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="/css/upload.css">
    <link rel="preload" href="https://unpkg.com/purecss@2.0.6/build/grids-min.css"
          integrity="sha384-N3kg2yavE4Br+aCjUS5x4dinn7lutx0KCF64Bi4g2Ku3QsCPnboAFmtJD9PPMp5o"
          crossorigin="anonymous" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://unpkg.com/purecss@2.0.6/build/buttons-min.css"
          integrity="sha384-Oo92Rb29UtGMNTtJSD1UyVdXMxEOInwQijx9Qf5tOzFaMNtqXO0dbSaIB2lfu+W3"
          crossorigin="anonymous" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript> <!-- fall back for non-js -->
        <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/grids-min.css"
              integrity="sha384-N3kg2yavE4Br+aCjUS5x4dinn7lutx0KCF64Bi4g2Ku3QsCPnboAFmtJD9PPMp5o"
              crossorigin="anonymous">
        <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/buttons-min.css"
              integrity="sha384-Oo92Rb29UtGMNTtJSD1UyVdXMxEOInwQijx9Qf5tOzFaMNtqXO0dbSaIB2lfu+W3"
              crossorigin="anonymous">
    </noscript>
    <script>
        let file = null

        function submitFile() {
            if (file === null) {
                alert("You need to select a file first!")
                return
            }

            if (confirm("Selected file, would you like to upload it?")) {
                let formData = new FormData();
                formData.append("file", file);
                fetch('/api/upload', {method: "POST", body: formData})
                    .then(data => {
                        if (data.status === 201) {
                            alert("Successfully uploaded!")
                        } else {
                            alert("Error when uploading: " + data.status + " " + data.statusText)
                        }
                    })
            }
        }

        function loadFile(event) {
            const output = document.getElementById('output');
            output.src = URL.createObjectURL(event.target.files[0]);
            file = event.target.files[0]
            // Clear object from memory
            URL.revokeObjectURL(output.src)
        }

        function onLoad() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            if (urlParams.has('signed_in')) { // TODO: Switch this to using cookies
                document.getElementById("sign-in-button").style.backgroundColor = '#5fc279';
                document.getElementById("sign-in-button").style.color = '#ffffff';
                document.getElementById("sign-in-button").onclick = null;
                document.querySelector('#sign-in-button').innerHTML =
                    '<img src="/svg/github_white.svg" alt="sign in with github button" class="button-icon"/>Signed In';
            }
        }
    </script>
</head>
<body onload="onLoad();">
<div class="pure-g">
    <div class="pure-u-1-3"></div>
    <div class="pure-u-1-3">
        <style scoped> /* for some reason this stuff doesn't work outside the html */
        .round-button {
            border-radius: 5px;
            font-size: 120%;
            margin-left: 10px;
        }

        /* Override the default gradient behavior */
        .pure-button:hover {
            background-image: none;
        }
        </style>
        <div class="main-form">
            <div class="browse-button-wrapper">
                <button class="round-button pure-button pure-button-primary">
                    <img src="/svg/file.svg" alt="browse button" class="button-icon"/>Browse
                </button>
                <input type="file" id="selected-file" accept="image/*" onchange="loadFile(event)">
            </div>
            <button type="submit" onclick="submitFile();" class="round-button pure-button pure-button-primary">
                <img src="/svg/upload.svg" alt="upload button" class="button-icon"/>Upload
            </button>
            <button type="submit" id="sign-in-button" onclick="location.href='/api/auth'"
                    class="round-button pure-button" style="margin-right: 10px">
                <img src="/svg/github.svg" alt="sign in with github button" class="button-icon"/>Sign In
            </button>
        </div>
        <img class="output-img" id="output"/>
    </div>
    <div class="pure-u-1-3"></div>
</div>

</body>
</html>
